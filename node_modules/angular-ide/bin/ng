#!/usr/bin/env node
const path = require('path');
const semver = require('semver');

const getNGCLIManifest = require('../lib/CLUtils').getNGCLIManifest;
const getNGCLIPath = require('../lib/CLUtils').getNGCLIPath;

const ngCLIPKG = getNGCLIManifest();

if (ngCLIPKG) {
  const normalizePackageVersion = require('../lib/CLUtils').normalizePackageVersion;
  const ngCLIPKGName = ngCLIPKG.name;
  const ngCLIPath = getNGCLIPath(ngCLIPKGName);

  ngCLIPKG.version = normalizePackageVersion(ngCLIPKG.version);

  if (semver.satisfies(ngCLIPKG.version, '>=1.0.0-beta.25')) {

    const Project = require(`../../${ngCLIPath}/ember-cli/lib/models/project`);

    Project.prototype.originalInitializeAddons = Project.prototype.initializeAddons;

    Project.prototype.initializeAddons = function monkeyInitializeAddons() {
      this.originalInitializeAddons();

      const cliPkg = require(path.resolve(__dirname, '../package.json'));
      const Addon = require(`../../${ngCLIPath}/ember-cli/lib/models/addon`);
      const Constructor = Addon.lookup({
        name: 'angular-ide',
        path: path.join(__dirname, '../../angular-ide'),
        pkg:  cliPkg,
      });

      const addon = new Constructor(this.addonParent, this);
      this.addons.push(addon);
    };
  }

  // run original ng serve
  require(`../../${ngCLIPath}/bin/ng`);
} else {
  debug(chalk.red('Unable to detect Angular CLI!!!'));
}